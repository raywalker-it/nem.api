/*! Australian National Energy Market API - v0.1.0 - 2014-06-10
* Copyright (c) 2014 Ray Walker; Licensed  */
!function(a){"use strict";a.QueryString=function(a){if(""===a)return{};for(var b={},c=0;c<a.length;++c){var d=a[c].split("=");2===d.length&&(b[d[0]]=decodeURIComponent(d[1].replace(/\+/g," ")))}return b}(window.location.search.substr(1).split("&"))}(jQuery),function(a,b,c,d){"use strict";function e(a,b,c,d){_.each(a.generators,function(a){return a.fuel_type?(q[b].generators[a.generator_id]=a,void(c[a.fuel_type]||(c[a.fuel_type]=[],_.find(d,a.fuel_type)||d.push(a.fuel_type)))):!0})}function f(a,b,c){_.each(a.values,function(a){var d=q[b].generators[a.g],e=1e3*a.t;d&&(c[d.fuel_type]||(c[d.fuel_type]=[]),c[d.fuel_type][e]?c[d.fuel_type][e]+=a.v:c[d.fuel_type][e]=a.v)})}function g(a,b,c,d){_.forIn(a,function(a,e){b[e]||(b[e]={name:a,data:[],state_index:d,color:p[a]?p[a]:""}),_.forIn(c[a],function(a,c){b[e].data.push([+c,a])})})}function h(a,b){a&&a.values&&(e(a,b,q[b].times,q[b].fuel_types),f(a,b,q[b].times),g(q[b].fuel_types,q[b].series,q[b].times,b))}function i(a,c){return c||(c=new b),"string"==typeof c&&(c=new b(c)),_.each(r,function(b){a&&b===a||c.removeQuery(b)}),c}function j(a){return a&&void 0!==a?c(a).isValid()?c(a):c.unix(a).isValid()?c.unix(a):!1:!1}function k(a,c){var d=!1,e=b.parseQuery(a.query());_.each(r,function(b){return e[b]?(d=!0,l(e,b,c),i(b,a),a.setQuery(e),!1):void 0}),d||(e.days=n.days,l(e,"days",c),a.setQuery(e))}function l(a,b,d){var e=j(a.start_time),f=j(a.end_time),g=d?"add":"subtract";return e?a.start_time=e[g](b,a[b]).unix():(f||(f=c()),a.end_time=f[g](b,a[b]).unix()),a}var m=a(d.document);Highcharts.setOptions({global:{useUTC:!1}});var n={api:"/api/v1.0/scada",days:3,maxupdates:24,interval:3e5},o={updateFromNow:!0},p={Fossil:"#666666",Hydro:"#87BAED",Wind:"#B5ED87",Solar:"#F5EC6E",Renewable:"#7BF56E"},q=[{name:"Victoria",ident:"VIC1"},{name:"New South Wales",ident:"NSW1"},{name:"South Australia",ident:"SA1"},{name:"Queensland",ident:"QLD1"},{name:"Tasmania",ident:"TAS1"},{name:"Australian Capital Territory",ident:"ACT1"}],r=["minutes","hours","days","weeks","months"];m.on("nem.get_chart_data",function(c,d,e){q[e].time=(new Date).getTime(),q[e].uri=new b(n.api),q[e].uri.setQuery(d),a.getJSON(q[e].uri.href(),function(a){h(a,e),m.ready(function(){m.trigger("nem.init_state_chart",[e])})})}),m.on("nem.fetch_new_chart_data",function(d,e){var f=n.interval/1e3/60;q[e].uri=i(!1,q[e].uri),o.updateFromNow?(q[e].uri.setQuery("end_time",c().unix()),q[e].uri.addQuery("minutes",f)):(q[e].uri.addQuery("minutes",f),q[e].uri.setQuery(l(b.parseQuery(q[e].uri.query()),"minutes",!0))),a.ajax({url:q[e].uri.href(),dataType:"json"}).success(function(a){m.trigger("nem.update_chart_data_"+e,[a])}).fail(function(a){console.error(a)}),--q[e].updates<1&&clearInterval(q[e].interval)}),m.on("nem.init_state_chart",function(b,d){q[d].chart=new Highcharts.Chart({title:{text:"Aggregate Power Generation by Fuel Type in "+q[d].name},chart:{defaultSeriesType:"areaspline",zoomType:"x",renderTo:q[d].ident,events:{load:function(){a.QueryString.live&&(q[d].interval=setInterval(function(){m.trigger("nem.fetch_new_chart_data",[d])},n.interval))}}},subtitle:{text:"Last updated "+c().calendar()+'<br/>Source: <a href="http://www.nemweb.com.au/Reports">National Energy Market</a>'},xAxis:{type:"datetime",dateTimeLabelFormats:{day:"%e %b %Y",month:"%e %b %Y",year:"%b"},title:{enabled:!1}},yAxis:[{title:{text:"megaWatts (MW)"},labels:{align:"right",x:3,y:16,format:"{value:.,0f}"},showFirstLabel:!1}],tooltip:{shared:!0,crosshairs:!0,valueSuffix:" MW",valueDecimals:1},plotOptions:{series:{cursor:"pointer",marker:{enabled:!1},fillOpacity:.3}},series:q[d].series}),m.on("nem.update_chart_data_"+d,function(a,b){if(b.values.length){var h=[],i=[],j=[],k=c().calendar();e(b,d,h,i),f(b,d,h),g(i,j,h,d),q[d].chart.series.forEach(function(a){j.forEach(function(b){b.name===a.name&&b.data.forEach(function(b){a.addPoint(b,!1,!1)})})}),q[d].chart.setTitle("Aggregate Power Generation by Fuel Type in "+q[d].name,"Last updated: "+k+'<br/>Source: <a href="http://www.nemweb.com.au/Reports">National Energy Market</a>'),q[d].chart.redraw()}}.bind(this)),a("#na_debug").append("<p>"+q[d].name+": "+((new Date).getTime()-q[d].time)+"ms")}),_.forIn(q,function(b,c){var d=["minutes","days","weeks","hours","months","start_time","end_time","time_start","time_end","tech","fuel","type","tech_desc","fuel_desc"],e={state:b.ident};b.times=[],b.generators=[],b.fuel_types=[],b.series=[],b.updates=n.maxupdates,a.each(d,function(b,c){var d=a.QueryString[c];d&&(e[c]=d)}),e.days||e.hours||e.weeks||e.months||(e.days=n.days),q[c]=b,m.trigger("nem.get_chart_data",[e,c])}),a(d.document).ready(function(){a.QueryString.live&&(a("nav .live").addClass("active"),a("#dashboard section p").first().text("Updating every "+n.interval/60/1e3+" minutes"),(a.QueryString.start_time||a.QueryString.time_start||a.QueryString.end_time||a.QueryString.time_end)&&(o.updatefromnow=!1)),a("#sticky").sticky(),a(".pagination a").on("click",function(c){c.preventDefault();var d=new b,e=this.hash.substring(1).split("-");switch(d.normalize(),a(this).toggleClass("active"),e[0]){case"page":k(d,"next"===e[1]?!0:!1);break;case"days":_.map(r,function(a){d.removeQuery(a)}),d.addQuery(e[0],e[1]);break;case"live":a.QueryString.live?d.removeQuery("live"):d.addQuery(e[0],"true");break;default:d.removeQuery(["start_time","time_start","end_time","time_end"])}window.location.href=d.href()})})}(jQuery,URI,moment,this);